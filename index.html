import { expect } from 'chai';
import { JSDOM } from 'jsdom';
import sinon from 'sinon';

// Simulate the login page
const { window } = new JSDOM(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
</head>
<body>
    <h2>Login</h2>
    <form id="loginForm">
        <label for="email">Email:</label><br>
        <input type="email" id="email" name="email" placeholder="Enter your email" required><br><br>

        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password" placeholder="Enter your password" required><br><br>

        <input type="submit" value="Login">
    </form>

    <script>
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'test@example.com' && password === 'password') {
                window.location.href = './next.html'; // Redirect to next page
            } else {
                alert('Invalid email or password.');
            }
        });
    </script>
</body>
</html>
`);

// Create a mock for window.location using a proxy
const mockLocation = new Proxy(
    {
        href: '',
    },
    {
        set(target, property, value) {
            if (property === 'href') {
                target.href = value; // Store the URL
                return true;
            }
            return false; // Disallow other properties
        },
        get(target, property) {
            return target[property]; // Return the property value
        },
    }
);

// Assign the mock location to window
Object.defineProperty(window, 'location', {
    value: mockLocation,
    writable: true,
});

describe('Login Functionality', function() {
    it('should redirect to next page with valid credentials', function() {
        // Set input values
        window.document.getElementById('email').value = 'test@example.com';
        window.document.getElementById('password').value = 'password';

        // Simulate form submission
        window.document.getElementById('loginForm').dispatchEvent(new window.Event('submit'));

        // Check if redirection happened
        expect(window.location.href).to.equal('./next.html');
    });

    it('should show an error with invalid credentials', function() {
        // Set input values
        window.document.getElementById('email').value = 'invalid@example.com';
        window.document.getElementById('password').value = 'wrongpassword';

        // Spy on the alert function
        const alertStub = sinon.stub(window, 'alert');

        // Simulate form submission
        window.document.getElementById('loginForm').dispatchEvent(new window.Event('submit'));

        // Check if alert was called
        expect(alertStub.calledOnce).to.be.true;
        expect(alertStub.calledWith('Invalid email or password.')).to.be.true;

        // Restore the original alert function
        alertStub.restore();
    });
});
